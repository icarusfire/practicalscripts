package com.example.prometheus;

import java.util.Set;

import org.openrewrite.ExecutionContext;
import org.openrewrite.java.JavaIsoVisitor;
import org.openrewrite.java.JavaTemplate;
import org.openrewrite.java.MethodMatcher;
import org.openrewrite.java.tree.J;
import org.openrewrite.recipe.Recipe;

public class ReplaceStaticBuildWithBuilder extends Recipe {

    private static final Set<String> METRICS =
            Set.of("Counter", "Gauge", "Histogram", "Summary");

    @Override
    public JavaIsoVisitor<ExecutionContext> getVisitor() {
        return new JavaIsoVisitor<>() {

            @Override
            public J.MethodInvocation visitMethodInvocation(J.MethodInvocation mi,
                                                            ExecutionContext ctx) {
                // always visit children first
                J.MethodInvocation m = super.visitMethodInvocation(mi, ctx);

                if (!"build".equals(m.getSimpleName())) {
                    return m;           // quick exit
                }

                // ───── Pull out the owner if present ─────
                String owner = null;
                if (m.getSelect() instanceof J.FieldAccess fa) {
                    owner = fa.getSimpleName();
                } else if (m.getSelect() instanceof J.Identifier id) {
                    owner = id.getSimpleName();
                }

                // ───── Static-import case: no owner ─────
                if (owner == null) {
                    return rewriteInvocation(m, null);
                }

                // ───── Qualified call: Counter.build(..) ─────
                if (METRICS.contains(owner)) {
                    return rewriteInvocation(m, m.getSelect());
                }
                return m;
            }

            /** Replace either `build()` or `build(n,h)` */
            private J.MethodInvocation rewriteInvocation(J.MethodInvocation m, J owner) {
                if (m.getArguments().isEmpty()) {
                    // …builder()
                    return m.withTemplate(
                            owner == null
                                    ? JavaTemplate.builder(this::getCursor, "builder()").build()
                                    : JavaTemplate.builder(this::getCursor, "#{any()}.builder()").build(),
                            m.getCoordinates().replace(),
                            owner);
                }
                if (m.getArguments().size() == 2) {
                    // …builder().name(a).help(b)
                    return m.withTemplate(
                            owner == null
                                    ? JavaTemplate.builder(this::getCursor,
                                            "builder().name(#{any(java.lang.String)}).help(#{any(java.lang.String)})")
                                          .build()
                                    : JavaTemplate.builder(this::getCursor,
                                            "#{any()}.builder().name(#{any(java.lang.String)}).help(#{any(java.lang.String)})")
                                          .build(),
                            m.getCoordinates().replace(),
                            owner,
                            m.getArguments().get(0),
                            m.getArguments().get(1));
                }
                return m;
            }
        };
    }
}

